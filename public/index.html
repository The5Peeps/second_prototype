<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"

    />

    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <!-- jquery CDN (content delivery network)-->
    <!-- used for the document data traversal in html form-->
    <!-- allows access to jquery libraries -->
    <script
    src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
    crossorigin="anonymous"></script>


    
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
      integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
      crossorigin=""
    />

    <script
      src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
      integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
      crossorigin=""
    ></script>

      <!-- Location toggle button-->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">

    
      <!-- Location pin drop css-->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@v0.74.0/dist/L.Control.Locate.min.css" />

    <style>
      #checkinMap {
        height: 500px;
        margin: 8px 0px;
      }

    </style>




    <title>City Fix App</title>
  </head>

  <body>
    <h1>CityFix App</h1>


    

    
  
    
    <div class="container">
        <form action="" id="signupForm">
          <label for="Long">Longitude</label>
          <input type="text" id="longitude" name="Long">
              
          <label for="Lat">Latitude</label>
          <input type= "text" id="latitude" name="Lat"></textarea>

          <label for="hazard">Hazard Type</label>
          <input type= "text" id="hazard" name="hazard"></textarea>

          <button id="submit">submit</button>


          <div id="checkinMap"></div>
        </form>
    </div>
  
    

  </body>
</html>


<!--Location Function source code from leaflet-->
<script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.74.0/dist/L.Control.Locate.min.js" charset="utf-8"></script>

<script> 



//initialize map
  const mymap = L.map('checkinMap').setView([34.0522, -118.2437], 10);
  
//initialize gps
  L.control.locate().addTo(mymap);



  const attribution =
    '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';
  //const tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
  const tileUrl = 'https://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png';
  const tiles = L.tileLayer(tileUrl, { attribution });
  tiles.addTo(mymap);


    let lat, lon;
    const button = document.getElementById('submit');
    button.addEventListener('click', async event => {

      //obtain values from text boxes
      const lat = document.getElementById('latitude').value;
      const lon = document.getElementById('longitude').value;
      const haz = document.getElementById('hazard').value;

      const data = { lat, lon, haz };
      const options = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      };
      const response = await fetch('/api', options);
      const json = await response.json();
      console.log(json);

    });


    var user_location = [34.0522, -118.2437]
    var marker ;

    // After the map style has loaded on the page, add a source layer and default
    // styling for a single point.
    mymap.on('load', function() {
        addMarker(user_location,'load');
      
        });

    
    mymap.on('click', function (e) {
        addMarker(e.latlng,'click');

        //console.log(e.latlng.lat);
        //document.getElementById("latitude").value = e.latlng.lat;
        //document.getElementById("longitude").value = e.latlng.lng;
    });

    
    
    
        
    function addMarker(latlng,event) {
          
      if(event === 'click'){
        user_location = latlng;
      }
                 
      var marker = new L.marker([user_location.lat, user_location.lng], { draggable: TextTrackCueList}).addTo(mymap);
            
      marker.on('dragend', function(e) {
        $("#latitude").val(this.getLatLng().lat);
        $("#longitude").val(this.getLatLng().lng);
      });   
            
                      
    }

   

  //pothole image marker
  //adds pothole image to saved markers
  var myIcon = L.icon({
      iconUrl: 'img/pothole.png',
      iconSize: [30,30],
      iconAnchor: [15, 10],
  });   


  //getData() fetches data from database
  //iterates through data and intitializes saved markers
  getData();
  async function getData() {
    const response = await fetch('/api');
    const data = await response.json();
    const pointList = [];
    //console.log(data);

    for (item of data) {
      pointList.push([item.lat, item.lon]);
      console.log(item);
      const marker = L.marker([item.lat, item.lon], {icon: myIcon} );
      var popup = marker.bindPopup('This is a pothole. ' + marker.getLatLng() ).openPopup()
      popup.addTo(mymap);
    }

  }
      
      
      
  </script>